<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Volt2U - Dashboard</title>
  <style>
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI',sans-serif; background:#111; color:#fff; }
    header { background:#000; padding:15px; display:flex;align-items:center;justify-content:space-between; }
    .menu-btn { font-size:28px;cursor:pointer;padding:5px 10px;border-radius:5px;background:#ffcc00;color:#000; }
    nav {
      position:fixed; top:0; left:-300px; width:300px; height:100%;
      background:#222; transition: left .3s; padding-top:60px;
    }
    nav.active { left:0; }
    nav a {
      display:block; padding:15px 20px; color:#fff; text-decoration:none;
      transition: background .2s;
    }
    nav a:hover { background:#ffcc00;color:#000; }
    main { margin-left:0; transition: margin .3s; padding:20px; }
    main.shifted { margin-left:300px; }
    section { display:none; }
    section.active { display:block; animation:fadeIn .3s; }
    @keyframes fadeIn { from{opacity:0;}to{opacity:1;} }
    form { background:#222; padding:20px; border-radius:10px; margin-bottom:20px; }
    label { display:block; margin:10px 0 5px; font-weight:bold; }
    input, select, button {
      width:100%; padding:10px; margin-bottom:10px;
      background:#333; color:#fff; border:1px solid #555; border-radius:5px;
    }
    button { background:#ffcc00; color:#000; cursor:pointer; }
    button:hover{ background:#e6b800; }
    .msg {
      padding:12px; margin:10px 0; border-radius:5px;
      font-size:0.95em;
    }
    .msg.success{background:#e0f7e9;color:#006622;}
    .msg.error{background:#fce4e4;color:#990000;}
  </style>
</head>
<body>
<header>
  <div class="menu-btn" onclick="toggleMenu()">☰</div>
  <h2>Bem-vindo, <span id="nomeUsuario">...</span></h2>
</header>

<nav id="sidebar">
  <a href="#" onclick="showSection('conta')">Minha Conta</a>
  <a href="#" onclick="showSection('residencia')">Adicionar Residência</a>
  <a href="#" onclick="showSection('energia')">Enviar Energia</a>
</nav>

<main id="main">
  <section id="conta" class="active">
    <h3>Minha Conta</h3>
    <p><strong>Nome:</strong> <span id="infoNome">--</span></p>
    <p><strong>Telefone:</strong> <span id="infoTelefone">--</span></p>
    <p><strong>Endereço:</strong> <span id="infoResidencia">Nenhuma registrada</span></p>
    <p><strong>Energia disponível:</strong> <span id="infoEnergia">0</span> kWh</p>
  </section>

  <section id="residencia">
    <h3>Adicionar / Editar Residência</h3>
    <form id="formResidencia">
      <label>CEP:</label><input type="text" name="cep" id="cepRes" required onblur="buscarCEP(this.value)">
      <label>Endereço:</label><input type="text" name="endereco" id="enderecoRes" required>
      <button type="submit">Salvar</button>
    </form>
    <div id="msgRes" class="msg"></div>
  </section>

  <section id="energia">
    <h3>Enviar Energia</h3>
    <form id="formEnergia">
      <label>CEP destinatário:</label><input type="text" id="cepDest" name="cep" required onblur="buscarDest(this.value)">
      <label>Endereço:</label><input type="text" id="enderecoDest" readonly>
      <label>Nome:</label><input type="text" id="nomeDest" readonly>
      <label>Telefone:</label><input type="text" id="telefoneDest" readonly>
      <label>Disponível (kWh):</label><input type="number" id="energiaDisp" readonly>
      <label>Quantidade (kWh):</label><input type="number" id="qtde" name="quantidade" min="1" required oninput="validarQtde()">
      <label>Tipo:</label>
      <select name="tipo"><option value="gratis">Grátis</option><option value="venda">Venda</option></select>
      <label>Preço total (R$):</label><input type="number" name="preco" step="0.01" min="0">
      <button type="submit">Enviar</button>
    </form>
    <div id="msgEnergia" class="msg"></div>
  </section>
</main>

<script>
function toggleMenu(){
  document.getElementById('sidebar').classList.toggle('active');
  document.getElementById('main').classList.toggle('shifted');
}

function showSection(id){
  document.querySelectorAll('main section').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  toggleMenu();
}

// Carrega dados do usuário
function carregarDadosUsuario(){
  fetch('session.php').then(res=>res.json()).then(d=>{
    if(d && d.nome){
      document.getElementById('nomeUsuario').textContent = d.nome;
      document.getElementById('infoNome').textContent = d.nome;
      document.getElementById('infoTelefone').textContent = d.telefone || '-';
      document.getElementById('infoResidencia').textContent = d.endereco || 'Nenhuma registrada';
      document.getElementById('infoEnergia').textContent = d.energia_disponivel || '0';
      document.getElementById('energiaDisp').value = d.energia_disponivel || '0';
    } else {
      window.location.href = 'index.html';
    }
  });
}
carregarDadosUsuario();

// CEP viaCEP
function buscarCEP(cep){
  cep = cep.replace(/\D/g,'');
  if(cep.length===8){
    fetch(`https://viacep.com.br/ws/${cep}/json/`)
    .then(r=>r.json()).then(d=>{
      if(!d.erro) document.getElementById('enderecoRes').value = `${d.logradouro}, ${d.bairro}, ${d.localidade}-${d.uf}`;
    });
  }
}

// Salvar residência
document.getElementById('formResidencia').addEventListener('submit', function(e){
  e.preventDefault();
  const data = new FormData(this);
  fetch('salvar_residencia.php', { method: 'POST', body: data })
    .then(r => r.text())
    .then(txt => {
      const msgRes = document.getElementById('msgRes');
      msgRes.textContent = txt;
      msgRes.className = txt.toLowerCase().includes('sucesso') ? 'msg success' : 'msg error';

      if (txt.toLowerCase().includes('sucesso')) {
        // Atualiza dados do usuário na tela, principalmente endereço
        carregarDadosUsuario();
      }
    });
});

// Buscar destinatário
function buscarDest(cep){
  cep = cep.replace(/\D/g,'');
  if(cep.length===8){
    fetch(`buscar_usuario_por_cep.php?cep=${cep}`)
    .then(r=>r.json()).then(d=>{
      if(d){
        document.getElementById('enderecoDest').value = d.endereco;
        document.getElementById('nomeDest').value = d.nome;
        document.getElementById('telefoneDest').value = d.telefone;
      }
    });
  }
}

// Validar quantidade
function validarQtde(){
  const qt = parseFloat(document.getElementById('qtde').value)||0;
  const max = parseFloat(document.getElementById('energiaDisp').value)||0;
  if(qt>max) document.getElementById('qtde').value = max;
}

// Enviar energia
document.getElementById('formEnergia').addEventListener('submit', function(e){
  e.preventDefault();
  const data = new FormData(this);
  fetch('enviar_energia.php',{method:'POST',body:data})
  .then(r=>r.text()).then(txt=>{
    document.getElementById('msgEnergia').textContent = txt;
    document.getElementById('msgEnergia').className = txt.toLowerCase().includes('realizada')?'msg success':'msg error';
    if(txt.toLowerCase().includes('realizada')){ this.reset(); document.getElementById('energiaDisp').value = 0; }
  });
});
</script>

</body>
</html>
